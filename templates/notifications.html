<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histori Notifikasi - Sistem Monitoring ONT</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .notification-item {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }
        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .notification-item.unread {
            background-color: #f8f9fa;
            border-left-color: #007bff;
        }
        .notification-item.unread:hover {
            background-color: #e9ecef;
        }
        .notification-type-info {
            border-left-color: #17a2b8;
        }
        .notification-type-success {
            border-left-color: #28a745;
        }
        .notification-type-warning {
            border-left-color: #ffc107;
        }
        .notification-type-error {
            border-left-color: #dc3545;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.75rem;
        }
        .timestamp {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .notification-message {
            font-weight: 500;
        }
        .filter-buttons {
            margin-bottom: 20px;
        }
        .filter-btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .filter-btn.active {
            background-color: #007bff;
            border-color: #007bff;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .real-time-timestamp {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row text-white p-3 mb-4" style="background: linear-gradient(135deg, #ff6b35 0%, #e74c3c 100%);">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-bell me-2"></i>
                        Histori Notifikasi
                    </h1>
                    <div>
                        <a href="/dashboard" class="btn btn-outline-light btn-sm me-2">
                            <i class="fas fa-home me-1"></i>
                            Dashboard
                        </a>
                        <a href="/admin" class="btn btn-outline-light btn-sm me-2">
                            <i class="fas fa-list me-1"></i>
                            Daftar ONT
                        </a>
                        <a href="/" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-map me-1"></i>
                            Peta
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <!-- Filter Buttons -->
                <div class="filter-buttons">
                    <button class="btn btn-outline-primary filter-btn active" data-filter="all">
                        <i class="fas fa-list me-1"></i>
                        Semua
                    </button>
                    <button class="btn btn-outline-info filter-btn" data-filter="info">
                        <i class="fas fa-info-circle me-1"></i>
                        Info
                    </button>
                    <button class="btn btn-outline-success filter-btn" data-filter="success">
                        <i class="fas fa-check-circle me-1"></i>
                        Sukses
                    </button>
                    <button class="btn btn-outline-warning filter-btn" data-filter="warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Peringatan
                    </button>
                    <button class="btn btn-outline-danger filter-btn" data-filter="error">
                        <i class="fas fa-times-circle me-1"></i>
                        Error
                    </button>
                    <button class="btn btn-outline-secondary filter-btn" data-filter="unread">
                        <i class="fas fa-envelope me-1"></i>
                        Belum Dibaca
                    </button>
                </div>
                <!-- Clear All Button -->
                <div class="mb-4">
                    <button id="clearAllBtn" class="btn btn-danger btn-sm me-2">
                    <i class="fas fa-trash-alt me-1"></i>
                    clear all
                    </button>
                    <button id="restoreBackupBtn" class="btn btn-warning btn-sm me-2">
                    <i class="fas fa-undo me-1"></i>
                    Restore from Backup
                    </button>
                    <span id="clearAllStatus" style="margin-left: 10px; font-size: 0.9em; color: #6c757d; display: none;"></span>
                </div>
                

                <!-- Notifications List -->
                <div id="notifications-container">
                    {% if notifications %}
                        {% for notification in notifications %}
                        <div class="card mb-3 notification-item {{ 'unread' if not notification.read }} notification-type-{{ notification.type }}" 
                             data-type="{{ notification.type }}" 
                             data-read="{{ 'true' if notification.read else 'false' }}"
                             data-id="{{ notification.id }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-{{ notification.type }} me-2">
                                                {% if notification.type == 'info' %}
                                                    <i class="fas fa-info-circle"></i>
                                                {% elif notification.type == 'success' %}
                                                    <i class="fas fa-check-circle"></i>
                                                {% elif notification.type == 'warning' %}
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                {% elif notification.type == 'error' %}
                                                    <i class="fas fa-times-circle"></i>
                                                {% endif %}
                                                {{ notification.type.upper() }}
                                            </span>
                                            {% if not notification.read %}
                                                <span class="badge bg-danger">BARU</span>
                                            {% endif %}
                                        </div>
                                        <p class="notification-message mb-2">{{ notification.message }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="real-time-timestamp">
                                                <i class="fas fa-clock me-1"></i>
                                                <span class="time-ago" data-timestamp="{{ notification.timestamp }}">Loading...</span>
                                            </small>
                                            {% if notification.ont_name %}
                                                <small class="text-muted">
                                                    <i class="fas fa-network-wired me-1"></i>
                                                    {{ notification.ont_name }}
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if not notification.read %}
                                        <button class="btn btn-sm btn-outline-primary mark-read-btn" 
                                                data-notification-id="{{ notification.id }}">
                                            <i class="fas fa-check"></i>
                                            Tandai Dibaca
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <h4>Tidak ada notifikasi</h4>
                            <p>Belum ada notifikasi yang tersimpan dalam sistem.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                
                // Update active button
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Filter notifications
                const notifications = document.querySelectorAll('.notification-item');
                notifications.forEach(notification => {
                    const type = notification.getAttribute('data-type');
                    const read = notification.getAttribute('data-read');
                    
                    let show = false;
                    
                    if (filter === 'all') {
                        show = true;
                    } else if (filter === 'unread') {
                        show = read === 'false';
                    } else {
                        show = type === filter;
                    }
                    
                    notification.style.display = show ? 'block' : 'none';
                });
            });
        });

        // Mark as read functionality
        document.querySelectorAll('.mark-read-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const notificationId = this.getAttribute('data-notification-id');
                const notificationItem = this.closest('.notification-item');
                
                fetch(`/api/notifications/mark-read/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        notificationItem.classList.remove('unread');
                        notificationItem.setAttribute('data-read', 'true');
                        this.remove();
                        
                        // Update unread count if exists
                        const unreadCount = document.querySelectorAll('.notification-item[data-read="false"]').length;
                        console.log('Unread notifications:', unreadCount);
                    }
                })
                .catch(error => {
                    console.error('Error marking notification as read:', error);
                    alert('Gagal menandai notifikasi sebagai dibaca');
                });
            });
        });

        // Clear All Notifications
        document.getElementById('clearAllBtn').addEventListener('click', function() {
        if (confirm('⚠️ PERHATIAN: Anda yakin ingin menghapus SEMUA notifikasi?\n\n' +
                   '• Tindakan ini tidak bisa dibatalkan\n' +
                   '• Semua riwayat notifikasi akan hilang\n' +
                   '• Backup otomatis akan dibuat sebelum penghapusan\n\n' +
                   'Ketik "HAPUS" untuk konfirmasi:')) {
            
            const confirmation = prompt('Ketik "HAPUS" untuk mengkonfirmasi penghapusan semua notifikasi:');
            if (confirmation !== 'HAPUS') {
                alert('Penghapusan dibatalkan');
                return;
            }
            
            // Tampilkan loading state
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Menghapus...';
            
            fetch('/api/notifications/clear-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
            })
            .then(response => response.json())
            .then(data => {
            const statusEl = document.getElementById('clearAllStatus');
            if (data.success) {
                statusEl.textContent = 'Semua notifikasi berhasil dihapus dan backup dibuat.';
                statusEl.style.color = '#28a745';
                statusEl.style.display = 'inline';
                
                // Kosongkan container dan tampilkan pesan kosong
                document.getElementById('notifications-container').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <h4>Tidak ada notifikasi</h4>
                    <p>Semua notifikasi telah dihapus. Backup otomatis telah dibuat.</p>
                    <small class="text-muted">Notifikasi baru akan muncul saat ada aktivitas sistem.</small>
                </div>
                `;
                
                // Sembunyikan tombol setelah berhasil
                this.style.display = 'none';
            } else {
                statusEl.textContent = 'Gagal menghapus: ' + (data.message || 'tidak diketahui');
                statusEl.style.color = '#dc3545';
                statusEl.style.display = 'inline';
                
                // Reset tombol
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-trash-alt me-1"></i>clear all';
            }
            })
            .catch(error => {
            console.error('Error clearing all notifications:', error);
            document.getElementById('clearAllStatus').textContent = 'Error jaringan.';
            document.getElementById('clearAllStatus').style.color = '#dc3545';
            document.getElementById('clearAllStatus').style.display = 'inline';
            
            // Reset tombol
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-trash-alt me-1"></i>clear all';
            });
        }
        });

        // Restore from Backup functionality
        document.getElementById('restoreBackupBtn').addEventListener('click', function() {
            if (confirm('Apakah Anda yakin ingin memulihkan notifikasi dari backup terbaru?\n\n' +
                       '• Notifikasi saat ini akan diganti dengan backup\n' +
                       '• Backup otomatis akan dibuat sebelum restore\n' +
                       '• Halaman akan di-refresh setelah restore')) {
                
                // Tampilkan loading state
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Restoring...';
                
                fetch('/api/notifications/restore-backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Berhasil memulihkan ${data.count} notifikasi dari backup!\nHalaman akan di-refresh.`);
                        location.reload();
                    } else {
                        alert('Gagal memulihkan: ' + (data.message || 'tidak diketahui'));
                        
                        // Reset tombol
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-undo me-1"></i>Restore from Backup';
                    }
                })
                .catch(error => {
                    console.error('Error restoring from backup:', error);
                    alert('Error jaringan saat memulihkan backup');
                    
                    // Reset tombol
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-undo me-1"></i>Restore from Backup';
                });
            }
        });

        // Real-time timestamp functions
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Baru saja';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} menit yang lalu`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} jam yang lalu`;
            } else if (diffInSeconds < 2592000) {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} hari yang lalu`;
            } else if (diffInSeconds < 31536000) {
                const months = Math.floor(diffInSeconds / 2592000);
                return `${months} bulan yang lalu`;
            } else {
                const years = Math.floor(diffInSeconds / 31536000);
                return `${years} tahun yang lalu`;
            }
        }

        function updateAllTimestamps() {
            const timeElements = document.querySelectorAll('.time-ago');
            timeElements.forEach(element => {
                const timestamp = element.getAttribute('data-timestamp');
                if (timestamp) {
                    element.textContent = formatTimeAgo(timestamp);
                }
            });
        }

        // Update timestamps immediately when page loads
        updateAllTimestamps();

        // Update timestamps every minute for real-time feel
        setInterval(updateAllTimestamps, 60000);

        // Auto refresh every 30 seconds
        // Fungsi untuk render ulang notifikasi ke dalam container
        function renderNotifications(notifications) {
            const container = document.getElementById('notifications-container');
            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <h4>Tidak ada notifikasi</h4>
                    <p>Belum ada notifikasi yang tersimpan dalam sistem.</p>
                </div>
                `;
                return;
            }
            let html = '';
            notifications.forEach(notification => {
                html += `
                <div class="card mb-3 notification-item ${!notification.read ? 'unread' : ''} notification-type-${notification.type}"
                     data-type="${notification.type}"
                     data-read="${notification.read ? 'true' : 'false'}"
                     data-id="${notification.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-${notification.type} me-2">
                                        ${notification.type === 'info' ? '<i class=\'fas fa-info-circle\'></i>' : ''}
                                        ${notification.type === 'success' ? '<i class=\'fas fa-check-circle\'></i>' : ''}
                                        ${notification.type === 'warning' ? '<i class=\'fas fa-exclamation-triangle\'></i>' : ''}
                                        ${notification.type === 'error' ? '<i class=\'fas fa-times-circle\'></i>' : ''}
                                        ${notification.type.toUpperCase()}
                                    </span>
                                    ${!notification.read ? '<span class="badge bg-danger">BARU</span>' : ''}
                                </div>
                                <p class="notification-message mb-2">${notification.message}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="real-time-timestamp">
                                        <i class="fas fa-clock me-1"></i>
                                        <span class="time-ago" data-timestamp="${notification.timestamp}">Loading...</span>
                                    </small>
                                    ${notification.ont_name ? `<small class="text-muted"><i class=\'fas fa-network-wired me-1\'></i> ${notification.ont_name}</small>` : ''}
                                </div>
                            </div>
                            ${!notification.read ? `<button class="btn btn-sm btn-outline-primary mark-read-btn" data-notification-id="${notification.id}"><i class=\'fas fa-check\'></i> Tandai Dibaca</button>` : ''}
                        </div>
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
            // Re-attach event listeners for mark as read
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const notificationId = this.getAttribute('data-notification-id');
                    const notificationItem = this.closest('.notification-item');
                    fetch(`/api/notifications/mark-read/${notificationId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            notificationItem.classList.remove('unread');
                            notificationItem.setAttribute('data-read', 'true');
                            this.remove();
                        }
                    });
                });
            });
            updateAllTimestamps();
        }

        // Auto refresh daftar notifikasi setiap 30 detik
        setInterval(() => {
            fetch('/api/notifications')
                .then(response => response.json())
                .then(data => {
                    renderNotifications(data);
                })
                .catch(error => console.error('Error refreshing notifications:', error));
        }, 30000);
    </script>
</body>
</html> 